---
title: "Métodos de Machine Learning na Produtividade de Soja"
author: "Arthur Hintz, Lucas Sartor"
date: "`r format(Sys.time(), '%d %b %Y')`"
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    number_sections: true       # numera seções automaticamente
    fig_caption: true           # ativa legendas automáticas em figuras
    toc: true                   # adiciona sumário
    toc_depth: 2                # profundidade do sumário
fontsize: 12pt
geometry: margin=2.5cm
linkcolor: blue
urlcolor: blue
colorlinks: true
header-includes:
  - \usepackage{indentfirst}
  - \setlength{\parindent}{1.25cm}
  - \setlength{\parskip}{0pt}
  - \usepackage{ragged2e}
  - \justifying
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(dpi = 200)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width=6, fig.height=4, fig.align='center')
```


```{r, include=FALSE}
library(tidyverse)
library(kableExtra)
library(skimr)
library(corrplot)
library(tidytext)
```

```{r, include=FALSE}
dados_ml <- read.csv2("dados_ml.csv") 
dados <- dados_ml
```

# Resumo

Este relatório apresenta o desenvolvimento de um projeto de Machine Learning realizado no âmbito da disciplina, empregando inicialmente métodos não supervisionados e, posteriormente, técnicas supervisionadas. São descritos os objetivos, o conjunto de dados, a metodologia empregada e os resultados obtidos, incluindo análises de sensibilidade com ênfase em validação, regularização e reprodutibilidade. Para a avaliação do desempenho preditivo, adotou-se a abordagem de validação cruzada (cross-validation).

# Introdução

Segundo a Confederação da Agricultura e Pecuária do Brasil (CNA), o agronegócio representou 23,8% do Produto Interno Bruto (PIB) brasileiro em 2023. Entre as commodities agrícolas, a soja destaca-se como aquela de maior valor de produção no país, conforme dados do IBGE. A produtividade das lavouras sofre influência de diversos fatores, muitos deles incontroláveis, como condições climáticas. No último ciclo, por exemplo, observou-se um aumento de 70,83% na produtividade em relação ao ano anterior, possivelmente associado ao maior volume de precipitação.

Diante desse contexto, torna-se essencial analisar as regiões do Rio Grande do Sul que apresentam maiores desafios produtivos, agrupando áreas com características semelhantes. Tal abordagem auxilia na compreensão dos fatores que diferenciam os ambientes de produção e pode apoiar estratégias de manejo mais eficientes.

Inicialmente, realiza-se uma análise descritiva do conjunto de dados para compreender as variáveis envolvidas e suas inter-relações. Em seguida, aplica-se o método k-means para identificar agrupamentos homogêneos (clusters). Posteriormente, estima-se o potencial produtivo de cada cluster por meio de um modelo de regressão.

Os dados utilizados neste estudo foram disponibilizados pela empresa Crops Team e foram coletados a partir de experimentos com cultivares de soja conduzidos em diversas localidades do estado do Rio Grande do Sul durante as safras de 2021/2022 e 2022/2023.

Este estudo é relevante pois permite identificar os principais determinantes da produtividade da soja, fornecendo subsídios para a tomada de decisões agrícolas e para a otimização dos rendimentos das cultivares. Ao compreender melhor os fatores que influenciam a produtividade, produtores e pesquisadores podem implementar práticas agrícolas mais eficientes, maximizando o potencial produtivo das regiões analisadas.

# Conjunto de Dados

 O conjunto de dados original continha informações provenientes dos quatro blocos de cada ensaio. As médias dos blocos por cultivar foram então calculadas, resultando em `r nrow(dados)` observações e `r ncol(dados)` variáveis. Após o processo de filtragem e tratamento de valores faltantes, obteve-se o banco de dados final utilizado nas análises.

-   **Cultivares:** Informações sobre as diferentes variedades de soja utilizadas nos experimentos.

-   **Localização:** Características geográficas dos locais onde os experimentos foram conduzidos.

-   **Dados Climáticos:** Informações sobre precipitação, temperatura e outras condições climáticas durante o período dos experimentos.

-   **Componentes Químicos do Solo:** Dados sobre a composição química do solo, incluindo níveis de nutrientes e pH.

Além disso:

1. Criou-se a variável dias, representando o número do dia do ano correspondente à data de semeadura.

1. Todas as variáveis não numéricas foram convertidas para fatores (factors) antes da modelagem.

Dessa forma, resultou na seguinte Tabela \@ref(tab:dados) que apresenta uma amostra aleatória de 10 linhas do conjunto de dados final.
```{r tab:dados, tab.cap="Banco de Dados."}
set.seed(8)
dados_t <- dados[sample(nrow(dados)),]

knitr::kable(head(dados_t, 10)) |>
  kableExtra::kable_styling(font_size = 10, full_width = FALSE)
```



# Análise Descritiva
  As análises dos dados referem-se a um processo crítico em relação produtividade de soja no RS. Dessa forma, foi verificado medidas de tendência central, medidas de disperção, as relações entre as variáveis e suas distribuições.

```{r, results='asis'}
skim(dados) |>
  dplyr::select(-complete_rate, -numeric.hist)
```

 Podemos verificar valores faltantes em algumas variáveis no banco de dados, dessa forma, foram retiradas essas observações devido a falta de informação para o preenchimento correto desses NA's. Além disso, podemos ter uma ideia da média e da distribuição dos dados

```{r}
dados <- na.omit(dados)

numeric_data <- dados %>% 
  select_if(is.numeric)

corr_matrix <- cor(numeric_data)
```
```{r corplot, fig.cap= "Corplot das Variáveis Numéricas", fig.width=8, fig.height=5}
corrplot(corr_matrix, method = "circle", type = "lower", 
         tl.cex = 0.6, order = 'AOE')
```

  A Figura `@ref(fig:corplot)` apresenta a matriz de correlação das variáveis numéricas. A intensidade e o tamanho dos círculos permitem identificar rapidamente associações fortes — positivas quando em azul, negativas quando em vermelho. Essa etapa auxilia na identificação de possíveis casos de multicolinearidade e variáveis potencialmente relevantes para explicar a produtividade.



A Figura `@ref(fig:histprod)` mostra a distribuição da produtividade (Kg/ha) ao longo das duas safras analisadas. A linha vertical laranja indica a média geral, igual a `r round(mean(dados$Produtividade), 2)`.

```{r histprod, fig.cap="Histograma da Produtividade de Soja"}
hist(dados$Produtividade,
     col="#cae9ff",
     border="black",
     xlab = "Produtividade (Kg/ha)", ylab = "Frequência",
     ylim = c(0, 150),
     main = "",
     nclass = 15)
abline(v = mean(dados$Produtividade), col = "#fb8500", lwd = 3)
legend(x="topright", c("Media"), 
       col = "#fb8500", lwd = 3) 
```

A Figura `@ref(fig:boxsafra)` compara a produtividade entre as safras 2021/2022 e 2022/2023. Verifica-se um aumento expressivo no segundo ciclo, provavelmente associado a condições climáticas mais favoráveis.

```{r boxsafra, fig.cap= "Boxplot da produtividade de soja", fig.height=3}
ggplot(dados) +
  aes(y = Produtividade, 
      fill = Safra, group = Safra) +
  geom_boxplot() +
  scale_fill_manual(values = c("#5fa8d3", "#fb8500"))+
  scale_y_continuous(expand = expansion(mult = c(0.03,0.05)),
                     breaks = c(0, 1000, 2000, 3000, 4000, 
                                5000, 6000, 7000)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```

A Figura `@ref(fig:boxlocais)` ilustra a variabilidade entre locais. Observa-se grande amplitude produtiva, com valores inferiores a 1000 kg/ha em Bossoroca e superiores a 6000 kg/ha na cidade de Torres, evidenciando forte heterogeneidade espacial.

```{r boxlocais, fig.cap= "Boxplot da Produtividade separada por Locais e por Safra"}
dados <- dados %>%
  mutate(Local_Safra = reorder_within(Local, Produtividade, Safra))

ggplot(dados) +
  aes(y = Produtividade, x = Local_Safra, fill = Safra) +
  geom_boxplot() +
  scale_fill_manual(values = c("#5fa8d3", "#fb8500")) +
  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05)),
                     breaks = c(0, 1000, 2000, 3000, 4000, 
                                5000, 6000, 7000)) +
  scale_x_reordered() +
  theme_classic() +
  labs(x = "") +
  theme(axis.text.x = element_text(angle = 45, size = 6,
                                   hjust = 1, vjust = 1, 
                                   color = "black"))
```

# Metodologia

A metodologia adotada neste estudo foi dividida em duas etapas principais:

(i) um procedimento de aprendizado não supervisionado, voltado à identificação de padrões estruturais nos ambientes experimentais; e

(ii) um processo de aprendizado supervisionado, cujo objetivo é a predição da produtividade de soja utilizando os agrupamentos previamente identificados.

## Aprendizado não supervisionado

  Para a etapa não supervisionada, empregou-se o algoritmo K-Means, cuja finalidade é particionar as observações em K grupos distintos, de modo que exista alta homogeneidade intra-cluster e heterogeneidade inter-cluster. Cada observação pertence exclusivamente a um único grupo, e a definição dos clusters é realizada minimizando a variabilidade interna de cada conjunto.
  Sejam $C_1, \cdots, C_K$ os conjuntos de índices das observações pertencentes a cada cluster e seja $X \in R^{n\times p}$ a matriz de dados padronizados. O critério otimizado pelo K-Means pode ser escrito como:
$$
\underset{C_1,...,C_K}{\operatorname*{\operatorname*{\operatorname*{minimize}}}}\left\{\sum_{k=1}^K\frac{1}{|C_k|}\sum_{i,i^{\prime}\in C_k}\sum_{j=1}^p(x_{ij}-x_{i^{\prime}j})^2\right\}.
$$
Em outras palavras, o método busca minimizar a soma das distâncias quadráticas entre cada observação e o centróide de seu respectivo grupo.
O algoritmo segue as seguintes etapas:
1. Inicialização: cada observação recebe aleatoriamente um rótulo entre 1 e K
These serve as initial cluster assignments for the observations.
1. Iteração (até convergência):
  a. recalcular os centróides de cada cluster;
  b. reatribuir cada observação ao cluster cujo centróide apresente menor distância Euclidiana.


A seleção do número adequado de clusters constitui uma etapa essencial do processo de agrupamento. Neste trabalho, foram avaliados valores de $K \in \{2,3,4,5,6,7,8\}$.Para determinar o particionamento mais apropriado, utilizou-se a métrica Within-Cluster Sum of Squares (WSS), definida como a soma das distâncias quadráticas entre cada observação e o centróide de seu respectivo cluster. Essa medida reflete a coerência interna dos grupos: valores menores indicam clusters mais compactos e homogêneos.

Formalmente, o WSS é expresso por:

$$\text{WSS}(K) = 
\sum_{k=1}^{K} \; \sum_{i \in C_k} \| x_i - \mu_k \|^{2}. $$

em que $C_k$ representa o conjunto de observações atribuídas ao cluster k e $\mu_k$ é seu centróide.

É importante destacar que o WSS sempre diminui à medida que o número de clusters aumenta, mesmo quando essa divisão não corresponde a uma estrutura real dos dados. Dessa forma, torna-se necessário identificar um ponto após o qual o decréscimo no WSS deixa de ser significativo — o chamado método do cotovelo.

No presente estudo, ainda que o WSS apresentasse redução contínua para valores crescentes de K, essa redução ocorreu de maneira aproximadamente linear, sem indicar um cotovelo claramente definido. Assim, considerando também o conhecimento prévio sobre a estrutura dos ambientes experimentais e a necessidade de manter interpretabilidade, optou-se por adotar K = 4 clusters.

Para inspeção visual dos clusters, realizou-se uma Análise de Componentes Principais (PCA), um método que projeta os dados para um espaço de menor dimensão preservando a maior variabilidade possível. O primeiro componente principal é definido por:

$$Z_1=\phi_{11}X_1+\phi_{21}X_2+\cdots+\phi_{p1}X_p,$$

em que o vetor $\phi_1 = (\phi_{11}, \phi_{21}, \cdots, \phi_{p1})^\top$ é obtido pela maximização da variância projetada sob a restrição de normalização.

A PCA permite representar os clusters em duas dimensões, fornecendo uma visão clara de sua dispersão e separabilidade. A Figura `@ref(fig:pca)` ilustra esta projeção, mostrando que os quatro grupos apresentam estrutura coerente, ainda que com alguma sobreposição esperada dada a complexidade dos ambientes agrícolas.

```{r pca, fig.cap="Análise de Componentes Principais"}
knitr::include_graphics("pca.pdf")
```


